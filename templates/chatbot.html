<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>DSA Chatbot</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">Learn DSA Topics</div>

        <div class="chat-box" id="chat-box">
            <!-- Messages will appear here -->
        </div>

        <div class="message-container">
            <input type="text" id="user-input" placeholder="Ask about any DSA topic..." onkeydown="checkEnter(event)">
            <button onclick="sendUserMessage()">Send</button>
        </div>
    </div>

    <script>
        const previousQueries = [];
        let historyIndex = -1;
        const inputField = document.getElementById("user-input");

        inputField.addEventListener("keydown", function (event) {
            if (event.key === "ArrowUp") {
                if (historyIndex > 0) {
                    historyIndex--;
                    inputField.value = previousQueries[historyIndex];
                } else if (historyIndex === -1 && previousQueries.length > 0) {
                    historyIndex = previousQueries.length - 1;
                    inputField.value = previousQueries[historyIndex];
                }
                event.preventDefault();
            } else if (event.key === "ArrowDown") {
                if (historyIndex < previousQueries.length - 1) {
                    historyIndex++;
                    inputField.value = previousQueries[historyIndex];
                } else {
                    historyIndex = -1;
                    inputField.value = "";
                }
                event.preventDefault();
            } else if (event.key === "Enter") {
                sendUserMessage();
            }
        });

        function sendUserMessage() {
            const userText = inputField.value.trim();

            if (userText !== "") {
                previousQueries.push(userText);
                historyIndex = -1;

                const chatBox = document.getElementById("chat-box");

                const userMessage = document.createElement("div");
                userMessage.className = "chat-message user-message";
                userMessage.textContent = userText;
                chatBox.appendChild(userMessage);

                fetch("/chatbot", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ msg: userText })
                })
                .then(response => response.json())
                .then(data => {
                    const botMessage = document.createElement("div");
                    botMessage.className = "chat-message bot-message";

                    if (data.type === "multi-code") {
                        const langButtons = document.createElement("div");
                        langButtons.className = "code-buttons";

                        const codeDisplay = document.createElement("pre");
                        codeDisplay.className = "code-area";

                        // Collect available code
                        const availableLangs = Object.keys(data.code).filter(
                            lang => data.code[lang] && data.code[lang].trim() !== ""
                        );

                        // Only create code area if there's at least one valid code
                        if (availableLangs.length > 0) {
                            codeDisplay.textContent = data.code.python || data.code[availableLangs[0]];

                            availableLangs.forEach(lang => {
                                const btn = document.createElement("button");
                                btn.textContent = lang.toUpperCase();
                                btn.style.marginRight = "5px";
                                btn.onclick = () => {
                                    codeDisplay.textContent = data.code[lang];
                                };
                                langButtons.appendChild(btn);
                            });

                            botMessage.appendChild(langButtons);
                            botMessage.appendChild(codeDisplay);
                        }

                        if (data.descriptions && data.descriptions.length > 0) {
                            const descPara = document.createElement("p");
                            descPara.textContent = data.descriptions[0];
                            botMessage.insertBefore(descPara, botMessage.firstChild);
                        }
                    } else {
                        botMessage.innerHTML = data.response;
                    }

                    chatBox.appendChild(botMessage);
                    chatBox.scrollTop = chatBox.scrollHeight;
                });

                inputField.value = "";
            }
        }
    </script>
</body>
</html>
